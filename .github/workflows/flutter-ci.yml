  # Keep all CI failure issues open but auto-close when resolved
  - name: Auto-close resolved CI failure issues
    if: success()
    uses: actions/github-script@v7
    with:
      script: |
        const issues = await github.rest.issues.listForRepo({
          owner: context.repo.owner,
          repo: context.repo.repo,
          state: 'open',
          labels: 'ci-failure,auto-generated'
        });

        for (const issue of issues.data) {
          // Auto-close only if issue title contains this branch or commit
          if (issue.title.includes(process.env.GITHUB_REF_NAME) ||
              issue.title.includes(process.env.GITHUB_SHA)) {
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              state: 'closed',
              body: "âœ… CI build has passed for this branch/commit. Closing issue automatically."
            });
            console.log(`Closed resolved CI issue #${issue.number}`);
          }
        }