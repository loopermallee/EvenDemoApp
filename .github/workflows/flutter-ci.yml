  - name: Check for existing open issues
    if: failure()
    id: check_issues
    uses: actions/github-script@v7
    with:
      script: |
        const issues = await github.rest.issues.listForRepo({
          owner: context.repo.owner,
          repo: context.repo.repo,
          state: 'open',
          labels: 'ci-failure,auto-generated'
        });
        
        // Close any existing auto-generated CI failure issues
        for (const issue of issues.data) {
          if (issue.title.includes('CI Build Failure')) {
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              state: 'closed'
            });
            console.log(`Closed previous issue #${issue.number}`);
          }
        }
        
        return 'ready';