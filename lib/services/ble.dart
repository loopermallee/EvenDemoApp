import 'dart:async';
import 'dart:typed_data';
import 'package:flutter/services.dart';
import 'package:flutter_blue_plus/flutter_blue_plus.dart';
import 'package:demo_ai_even/services/evenai.dart'; // üÜï import EvenAI

class BLEService {
  static const _serviceChannel =
      MethodChannel("com.example.demo_ai_even/ble_service");

  final FlutterBluePlus _flutterBlue = FlutterBluePlus.instance;
  BluetoothDevice? connectedDevice;

  BluetoothCharacteristic? _micCharacteristic;
  final List<int> _micBuffer = []; // üÜï store incoming audio

  /// Scan for BLE devices
  Future<List<BluetoothDevice>> scanForDevices() async {
    final results = <BluetoothDevice>[];
    await _flutterBlue.startScan(timeout: const Duration(seconds: 5));

    await for (final result in _flutterBlue.scanResults) {
      results.add(result.device);
    }

    await _flutterBlue.stopScan();
    return results;
  }

  /// Connect to device + discover services + start mic notifications
  Future<void> connectToDevice(BluetoothDevice device) async {
    await device.connect(autoConnect: false);
    connectedDevice = device;

    // ‚úÖ Start foreground service (keeps BLE alive on lockscreen)
    try {
      await _serviceChannel.invokeMethod("startForegroundService");
    } catch (e) {
      print("‚ö†Ô∏è Failed to start foreground service: $e");
    }

    // Discover services
    List<BluetoothService> services = await device.discoverServices();
    for (var service in services) {
      for (var char in service.characteristics) {
        // üÜï Assume mic data characteristic UUID (replace with real UUID)
        if (char.properties.notify &&
            char.uuid.toString().toLowerCase().contains("abcd")) {
          _micCharacteristic = char;
          await _micCharacteristic!.setNotifyValue(true);

          _micCharacteristic!.value.listen((data) {
            _micBuffer.addAll(data);
          });

          print("üé§ Mic characteristic subscribed");
        }
      }
    }
  }

  /// Stop mic recording ‚Üí flush buffer to EvenAI
  Future<void> stopMicRecording() async {
    if (_micBuffer.isEmpty) {
      print("‚ö†Ô∏è No audio captured");
      return;
    }

    final audioBytes = Uint8List.fromList(_micBuffer);

    // Send to EvenAI pipeline (STT ‚Üí ChatGPT ‚Üí HUD)
    await EvenAI.get.recordOverByOS(audioBytes);

    _micBuffer.clear();
  }

  /// Disconnect device + stop Foreground Service
  Future<void> disconnectFromDevice(BluetoothDevice device) async {
    try {
      await device.disconnect();
      connectedDevice = null;

      // ‚úÖ Stop foreground service
      await _serviceChannel.invokeMethod("stopForegroundService");
    } catch (e) {
      print("‚ö†Ô∏è Failed to stop service: $e");
    }
  }

  /// Try reconnecting to last device
  Future<BluetoothDevice?> reconnectLastDevice() async {
    final connected = await _flutterBlue.connectedDevices;
    if (connected.isNotEmpty) {
      connectedDevice = connected.first;
      return connectedDevice;
    }
    return null;
  }

  /// ‚úÖ Force ensure connection (calls Kotlin BleManager.ensureConnected)
  Future<void> ensureConnected() async {
    try {
      await _serviceChannel.invokeMethod("ensureConnected");
      print("üîÑ Ensuring BLE connection via ForegroundService");
    } catch (e) {
      print("‚ö†Ô∏è Failed to ensure reconnect: $e");
    }
  }
}