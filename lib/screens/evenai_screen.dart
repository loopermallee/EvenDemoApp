// lib/screens/evenai_screen.dart
import 'package:flutter/material.dart';
import 'package:get/get.dart';
import '../services/evenai.dart';
import 'package:flutter_blue_plus/flutter_blue_plus.dart';

class EvenAIScreen extends StatefulWidget {
  const EvenAIScreen({super.key, this.connectedDevice});

  final BluetoothDevice? connectedDevice;

  @override
  State<EvenAIScreen> createState() => _EvenAIScreenState();
}

class _EvenAIScreenState extends State<EvenAIScreen> {
  final TextEditingController _controller = TextEditingController();
  final EvenAI evenAI = EvenAI.to;

  String response = "";
  bool isListening = false; // âœ… Glasses mic state

  /// Manual query (debug mode only)
  Future<void> sendQuery() async {
    final query = _controller.text.trim();
    if (query.isEmpty) return;

    setState(() {
      response = "ðŸ¤– Thinking...";
    });

    final result = await evenAI.processTranscript(query);

    if (mounted) {
      setState(() => response = "Manual: $query\n\n$result");
    }
  }

  /// âœ… Triggered when glasses mic starts
  Future<void> startMic() async {
    setState(() {
      isListening = true;
      response = "ðŸŽ¤ Listening via glasses mic...";
    });
    // Instead of processing here, we just notify EvenAI
    await evenAI.startListening(Uint8List(0));
  }

  /// âœ… Triggered when glasses mic stops
  Future<void> stopMic() async {
    setState(() {
      isListening = false;
      response = "ðŸ¤– Processing...";
    });

    // Simulate receiving a transcript (in real case, Kotlin plugin sends it)
    await evenAI.processTranscript("Example transcript from glasses");

    if (mounted) {
      setState(() => response = evenAI.lastTranscript.value);
    }
  }

  @override
  Widget build(BuildContext context) {
    final theme = Theme.of(context);

    return Scaffold(
      appBar: AppBar(
        title: const Text("ðŸ¤– EVEN AI"),
        centerTitle: true,
        actions: [
          // âœ… Mic control buttons (for testing until glasses auto-trigger is wired)
          IconButton(
            icon: const Icon(Icons.mic, color: Colors.greenAccent),
            onPressed: startMic,
            tooltip: "Start Listening",
          ),
          IconButton(
            icon: const Icon(Icons.stop, color: Colors.redAccent),
            onPressed: stopMic,
            tooltip: "Stop & Send",
          ),
        ],
      ),
      body: Padding(
        padding: const EdgeInsets.all(16),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            // âœ… BLE Status Banner
            Container(
              width: double.infinity,
              padding: const EdgeInsets.all(8),
              color: widget.connectedDevice != null
                  ? Colors.green.shade900
                  : Colors.red.shade900,
              child: Text(
                widget.connectedDevice != null
                    ? "ðŸŸ¢ Connected to ${widget.connectedDevice!.name.isNotEmpty ? widget.connectedDevice!.name : widget.connectedDevice!.id}"
                    : "ðŸ”´ Not Connected",
                style: theme.textTheme.bodyMedium?.copyWith(
                  color: Colors.greenAccent,
                  fontWeight: FontWeight.bold,
                ),
              ),
            ),
            const SizedBox(height: 16),

            // âœ… Listening indicator
            if (isListening)
              Padding(
                padding: const EdgeInsets.only(bottom: 12),
                child: Text(
                  "ðŸŽ¤ Glasses mic active... speak now!",
                  style: theme.textTheme.bodyMedium?.copyWith(
                    color: Colors.greenAccent,
                    fontStyle: FontStyle.italic,
                  ),
                ),
              ),

            // âœ… Debug input field (manual queries)
            TextField(
              controller: _controller,
              style: theme.textTheme.bodyLarge,
              cursorColor: Colors.greenAccent,
              decoration: const InputDecoration(
                hintText: "Type here (debug only)...",
              ),
              onSubmitted: (_) => sendQuery(),
            ),
            const SizedBox(height: 12),

            // âœ… Send button
            ElevatedButton(
              onPressed: sendQuery,
              child: const Text("SEND"),
            ),
            const SizedBox(height: 24),

            // âœ… AI Response
            Expanded(
              child: SingleChildScrollView(
                child: Text(
                  response.isEmpty ? "No reply yet." : response,
                  style: theme.textTheme.bodyLarge?.copyWith(
                    color: Colors.greenAccent,
                  ),
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }
}